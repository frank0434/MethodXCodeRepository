---
title: "Data_acquisition"
author: "jian (AKA Frank) liu"
date: "04/10/2019"
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_depth: 3
---

# ReadMe

**This is the notebook to import the data from K/I/whatever the driver is and send raw/cleaned data to a postgresql DB on powerplant.**

**Plan:**

1. Read data in
2. Select down to right soil water measurments
3. Send the raw data from each measurment to DB - this is for examing the suprise values 
4. Clean out missing and stupid high values   _Yet to be done_
5. Average the value in each layer (7 layers in total for rainshelter; 4 layers for the stony lysimeter)
6. Calculate deficit 
7. Upload the calculated deficit to DB - for real irrigation scheduling - need to be a separate table 

**PostgreSQL credentials**

    host = "database.powerplant.pfr.co.nz",
    database = "cflfcl_MPI_SVS",
    user = "cflfcl_SVS",
    password = "vVsYDCzw7PD4Phb1"
    
**Format that `sqlalchemy` like**
    
    "postgresql://cflfcl_SVS:vVsYDCzw7PD4Phb1@database.powerplant.pfr.co.nz/cflfcl_MPI_SVS"
    
**Demo data source**

    
**Outcomes**

### libraries


```{r setup, include=FALSE,warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
source("packages.R")
```

### DataSource

```{r}
url = "https://iplant.plantandfood.co.nz/project/I190710/DataProtocols/SVS_PotatoOnion_SoilWater.xlsx"

sheet = "SoilWaterMainData"
GET(url, authenticate(Sys.getenv("USERNAME"), Sys.getenv("PASSWORD"),
                       type = "ntlm"), 
    write_disk(tf <- tempfile(fileext = ".xlsx"), overwrite = TRUE)) 
list.files(tf)
df = read_excel(tf, sheet, skip = 9,.name_repair = "universal") %>% 
  as.data.table()
colnames(df)
```
```{r}
con = dbConnect(PostgreSQL(), 
                host = "database.powerplant.pfr.co.nz",
                dbname  = "cflfcl_MPI_SVS",
                user = "cflfcl_SVS",
                password = "vVsYDCzw7PD4Phb1" )

dbListTables(con)
dbWriteTable(con, sheet, df)

```

